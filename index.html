<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa – Ocorrências por Região</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

  <style>
    :root{ --bg:#ffffff; --panel:#f5f7fb; --text:#0b1020; --muted:#5b6b82; --border:#e9eef7; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial; }
    .app { display:grid; grid-template-rows:auto 1fr auto; height:100%; }

    header { display:flex; flex-wrap:wrap; gap:16px; align-items:center; padding:12px 16px;
      background:var(--panel); box-shadow:0 2px 12px rgba(0,0,0,.08); position:sticky; top:0; z-index:1000; }
    header h1 { font-size:18px; margin:0; letter-spacing:.2px; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; font-size:14px; color:var(--muted); }
    .badge { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#eef2f9; }
    .select { padding:6px 10px; border:1px solid #dbe3f0; border-radius:8px; background:#fff; color:#0b1020; }

    #map { height: 100%; }

    .legend, .color-legend { position:absolute; right:10px; background:rgba(255,255,255,0.98); color:#111827;
      padding:10px 12px; border-radius:10px; font:12px system-ui; z-index:500; border:1px solid var(--border); }
    .legend { bottom: 160px; }
    .legend .row { display:flex; align-items:center; margin:4px 0; gap:8px; }
    .legend .dot { width:14px; height:14px; border-radius:4px; background:#1976d2; }
    .color-legend { bottom: 260px; }
    .color-legend .item { display:flex; align-items:center; gap:8px; margin:4px 0; }
    .color-legend .box { width:14px; height:14px; border-radius:3px; }

    .timeline { position: fixed; left: 20px; right: 20px; bottom: 16px; z-index: 1000; display: none;
      padding: 10px 16px; background: transparent; border-top: 1px solid rgba(0,0,0,0.2); }
    .timeline .label { margin: 0 0 8px 2px; color: #1976d2; font: 700 13px system-ui; text-shadow: 0 1px 2px rgba(255,255,255,0.6); }
    .timeline .track { position: relative; height: 8px; background: #1976d2; border-radius: 999px; box-shadow: inset 0 0 0 2px rgba(255,255,255,0.8); }
    .timeline .handle { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 20px; height: 20px; border-radius: 50%;
      background: #0d47a1; border: 2px solid #bbdefb; box-shadow: 0 2px 8px rgba(0,0,0,0.35); cursor: grab; }
    .timeline .ticks { display:flex; justify-content: space-between; margin-top: 6px; color: #1976d2; font: 700 12px/1 system-ui; text-shadow: 0 1px 2px rgba(255,255,255,0.6); }
    .timeline .year { user-select: none; }

    .kml-busy { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.75);
      color:#fff; padding:8px 12px; border-radius:8px; display:none; z-index:700; }
    .leaflet-popup-content-wrapper { border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.15); }
    .leaflet-popup-content { margin: 12px 16px; }
    table.minimal { border-collapse: collapse; width: 100%; font-size: 12px; }
    table.minimal td, table.minimal th { border-bottom: 1px solid #eee; padding: 4px 6px; text-align: left; }

    @media (max-width: 640px) {
      .timeline { background: linear-gradient(to top, rgba(255,255,255,0.96), rgba(255,255,255,0.90)); }
      .timeline .label, .timeline .ticks { text-shadow: 0 1px 2px rgba(0,0,0,0.12); }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Mapa — Ocorrências por Região</h1>
      <div class="controls">
        <label class="badge">Tipo:
          <select id="tipoSel" class="select">
            <option value="__all__">Todas</option>
            <option value="ameaca">Ameaça</option>
            <option value="consumo_de_drogas">Consumo de Drogas</option>
            <option value="furto">Furto</option>
            <option value="homicidios">Homicídios</option>
            <option value="roubo">Roubo</option>
            <option value="trafico_de_drogas">Tráfico de Drogas</option>
          </select>
        </label>
        <label class="badge">Ano:
          <select id="anoSel" class="select"></select>
        </label>
        <label class="badge">Região:
          <select id="distritoSel" class="select"><option value="__all__">Todas</option></select>
        </label>
        <span class="badge"><strong id="sumTotal">—</strong> total no ano</span>
        <button id="btnReset" class="badge" style="cursor:pointer;">Limpar</button>
      </div>
    </header>

    <div id="map"></div>

    <div class="timeline" id="timeline">
      <div class="label">Linha do tempo (arraste o marcador)</div>
      <div class="track" id="track"><div class="handle" id="handle" style="left:0%;"></div></div>
      <div class="ticks" id="ticks"></div>
    </div>
  </div>

  <div id="busy" class="kml-busy">Carregando dados...</div>

  <div class="legend">
    <h4 style="margin:0 0 6px;">Densidade de ocorrências</h4>
    <div class="row"><span class="dot" style="opacity:0.2"></span> Baixa</div>
    <div class="row"><span class="dot" style="opacity:0.55"></span> Média</div>
    <div class="row"><span class="dot" style="opacity:0.9"></span> Alta</div>
  </div>

  <div class="color-legend" id="colorLegend">
    <h4 style="margin:0 0 6px;">Cores por distrito</h4>
  </div>

  <script>
   // === KMLs (mantendo seus caminhos) ===
    const KML_MAP = {
      "Barcarena (Sede)": "web/kml/barcarena.kml",
      "Estradas": "web/kml/estradas.kml",
      "Ilhas": "web/kml/ilhas.kml",
      "Murucupi": "web/kml/murucupi.kml",
      "Vila do Conde": "web/kml/viladoconde.kml",
    };
    const COLOR_MAP = {
      "BARCARENA": "#1f77b4",
      "ESTRADAS": "#8c564b",
      "ILHAS": "#e377c2",
      "MURUCUPI": "#ff7f0e",
      "VILA DO CONDE": "#9467bd",
    };

    // === CSVs ===
    const CSV_SOURCES = [
      { key: "ameaca", path: "data/ameacas.csv", label: "Ameaça" },
      { key: "consumo_de_drogas", path: "data/consumo_de_drogas.csv", label: "Consumo de Drogas" },
      { key: "furto", path: "data/furto.csv", label: "Furto" },
      { key: "homicidios", path: "data/homicidios.csv", label: "Homicídios" },
      { key: "roubo", path: "data/roubo.csv", label: "Roubo" },
      { key: "trafico_de_drogas", path: "data/trafico_de_drogas.csv", label: "Tráfico de Drogas" },
    ];
    const CSV_YEAR = "ano", CSV_DISTRICT = "distrito", CSV_VALUE = "ocorrencias", CSV_DESC = "descricao";

    const YEARS = Array.from({length: 2021-2010+1}, (_,i)=> (2010+i));
    let currentYear = 2010;

    // === Mapa ===
    const map = L.map('map').setView([-1.4558, -48.4902], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

    const districtLayers = {};    // key -> L.LayerGroup
    const districtNameByKey = {};
    const yearCacheAll = {}; const yearCachePerType = {};
    const popupLayer = L.layerGroup().addTo(map);

    // === Timeline ===
    const tl = document.getElementById("timeline");
    const track = document.getElementById("track");
    const handle = document.getElementById("handle");
    const ticks = document.getElementById("ticks");

    function normalizeName(s){
      if (!s) return "";
      return String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^A-Za-z0-9 ]+/g,' ').replace(/\s+/g,' ').trim().toUpperCase();
    }
    function applyStyle(group, color, opacity){
      group.eachLayer(function(lyr){
        if (lyr.setStyle){
          lyr.setStyle({ color: color, weight: 1.5, opacity: opacity, fillColor: color, fillOpacity: opacity });
        }
      });
    }
    function setDistrictOpacity(key, value, min, max){
      const group = districtLayers[key]; if (!group) return;
      const color = COLOR_MAP[key] || "#1976d2";
      const lerp=(a,b,t)=>a+(b-a)*t; let opacity=0.2;
      if (Number.isFinite(value) && max>min){ const frac=(value-min)/(max-min); opacity=lerp(0.15,0.9,frac); }
      else if (Number.isFinite(value) && max===min && max>0){ opacity=0.9; }
      applyStyle(group, color, opacity);
    }

    // === Popup inclui Descrição (se houver no CSV do tipo selecionado) ===
    function popupHtmlFor(humanName, summary){
      const rows = summary ? Object.entries(summary.byType).sort((a,b)=> b[1]-a[1]) : [];
      const table = rows.length ? `<table class="minimal"><thead><tr><th>Tipo</th><th>Ocorrências</th></tr></thead><tbody>${
        rows.map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join("")}
      </tbody></table>` : `<i>Sem detalhamento por tipo</i>`;
      const selTipo = document.getElementById("tipoSel").value;
      const label = (selTipo==="__all__"?"":`<div><b>Tipo:</b> ${getSelectedTypeLabel()}</div>`);
      const descBlock = (summary && summary.desc) ? `<div style="margin-top:6px;"><b>Descrição:</b> ${summary.desc}</div>` : "";
      return [
        `<b>${humanName}</b>`,
        `<div><b>Ano:</b> ${currentYear}</div>`,
        label,
        `<div><b>Total:</b> ${summary?summary.total:0}</div>`,
        descBlock,
        `<div style="margin-top:6px;"><b>Por tipo:</b></div>`,
        table
      ].join("");
    }

    function getSelectedTypeLabel(){
      const val = document.getElementById("tipoSel").value;
      if (val === "__all__") return "Todas";
      const src = CSV_SOURCES.find(s=>s.key===val);
      return src ? src.label : val;
    }

    function fitAll(){
      try{
        const group = L.featureGroup(Object.values(districtLayers));
        if (group.getLayers().length) map.fitBounds(group.getBounds(), {padding:[20,20]});
      }catch(e){}
    }

    (async function init(){
      await loadAllKmls();
      await preloadCsvs();

      // anos select
      const anoSel=document.getElementById("anoSel");
      YEARS.forEach(y=>{ const o=document.createElement("option"); o.value=String(y); o.textContent=String(y); anoSel.appendChild(o); });
      anoSel.value=String(currentYear);
      buildDistrictSelect();
      buildColorLegend();
      buildTicks();
      await applyFilters();
      fitAll();

      // listeners
      document.getElementById("tipoSel").addEventListener("change", ()=>{ applyFilters(); refreshPopupsIfTimeline(); });
      document.getElementById("anoSel").addEventListener("change", ()=>{
        const y = parseInt(document.getElementById("anoSel").value, 10);
        currentYear = y;           // atualiza o ano atual
        syncHandleToYear();        // move o "pino" da timeline
        applyFilters();            // aplica filtros/estilo
        refreshPopupsIfTimeline(); // atualiza o popup fixo (se timeline ativa)
      });
      document.getElementById("distritoSel").addEventListener("change", ()=>{
        updateDistrictVisibility();
        toggleTimelineAccordingToDistrict();
        applyFilters();
        refreshPopupsIfTimeline();
      });

      // drag controls
      initDragTimeline();
      toggleTimelineAccordingToDistrict();
    })();

    async function loadAllKmls(){
      for (const [name,file] of Object.entries(KML_MAP)){
        const key=normalizeName(name);
        await new Promise((resolve)=>{
          const group = omnivore.kml(encodeURI(file));
          group.on('ready', function(){
            const color = COLOR_MAP[key] || "#1976d2";
            applyStyle(group, color, 0.25);
            // clique para popup quando "Todos"
            group.eachLayer(function(lyr){
              lyr.on('click', (e)=>{
                const sel = document.getElementById("distritoSel").value;
                const timelineEnabled = (sel && sel !== "__all__");
                if (timelineEnabled){ refreshPopupsIfTimeline(); return; }
                const data = getActiveAgg()[currentYear] || { byDistrict:{} };
                const nameHuman = districtNameByKey[key] || key;
                const summary = data.byDistrict[key];
                const html = popupHtmlFor(nameHuman, summary);
                L.popup()
                  .setLatLng(e.latlng || (lyr.getBounds?lyr.getBounds().getCenter():map.getCenter()))
                  .setContent(html)
                  .openOn(map);
              });
            });
            districtLayers[key]=group;
            districtNameByKey[key]=name;
            group.addTo(map);
            resolve();
          });
          group.on('error', function(){ console.warn("Falha ao carregar KML:", file); resolve(); });
        });
      }
    }

    async function preloadCsvs(){
      // por tipo (cada tipo passa a carregar também uma possível descrição por distrito/ano)
      for (const src of CSV_SOURCES){
        const rows = await loadCsv(src.path);
        const cache={};
        for (const y of YEARS){
          const agg={};
          for (const r of rows.filter(r=> String(r[CSV_YEAR])===String(y))){
            const key = normalizeName(r[CSV_DISTRICT]);
            const val = Number(r[CSV_VALUE]) || 0;
            if (!agg[key]) agg[key]={ total:0, byType:{}, desc: undefined };
            agg[key].total += val;
            // Por tipo
            agg[key].byType[src.label] = (agg[key].byType[src.label] || 0) + val;
            // Descrição (se existir no CSV do tipo)
            const d = (r[CSV_DESC]!==undefined && r[CSV_DESC]!==null) ? String(r[CSV_DESC]).trim() : "";
            if (d) agg[key].desc = d;
          }
          const totals=Object.values(agg).map(x=>x.total);
          cache[y]={ byDistrict:agg, min:(totals.length?Math.min(...totals):0), max:(totals.length?Math.max(...totals):0) };
        }
        yearCachePerType[src.key]=cache;
      }
      // todas (soma dos tipos); por padrão NÃO mostramos descrição em "Todas"
      for (const y of YEARS){
        const agg={};
        for (const src of CSV_SOURCES){
          const cache = yearCachePerType[src.key][y] || {byDistrict:{}};
          for (const [key,obj] of Object.entries(cache.byDistrict)){
            if (!agg[key]) agg[key]={ total:0, byType:{}, desc: undefined };
            agg[key].total += obj.total;
            for (const [label,v] of Object.entries(obj.byType)){
              agg[key].byType[label] = (agg[key].byType[label] || 0) + v;
            }
          }
        }
        const totals=Object.values(agg).map(x=>x.total);
        yearCacheAll[y]={ byDistrict:agg, min:(totals.length?Math.min(...totals):0), max:(totals.length?Math.max(...totals):0) };
      }
    }

    function loadCsv(path){
      return new Promise((resolve)=>{
        Papa.parse(path,{ header:true, download:true, dynamicTyping:true,
          complete:(res)=>{ const rows=(res.data||[]).filter(r=> r && r.hasOwnProperty(CSV_YEAR) && r.hasOwnProperty(CSV_DISTRICT) && r.hasOwnProperty(CSV_VALUE)); resolve(rows); },
          error:()=> resolve([])
        });
      });
    }

    function buildDistrictSelect(){
      const sel=document.getElementById("distritoSel");
      sel.querySelectorAll("option:not([value='__all__'])").forEach(o=>o.remove());
      const list = Object.entries(districtNameByKey).map(([k,v])=>({key:k, name:v})).sort((a,b)=> a.name.localeCompare(b.name,'pt-BR'));
      for (const item of list){ const o=document.createElement("option"); o.value=item.key; o.textContent=item.name; sel.appendChild(o); }
    }

    function buildColorLegend(){
      const el = document.getElementById("colorLegend");
      const rows = Object.entries(districtNameByKey).map(([k,v])=>({key:k, name:v, color: COLOR_MAP[k] || "#1976d2"}))
        .sort((a,b)=> a.name.localeCompare(b.name,'pt-BR'));
      el.innerHTML = `<h4 style="margin:0 0 6px;">Cores por distrito</h4>` + rows.map(r=>`
        <div class="item">
          <span class="box" style="background:${r.color}"></span>
          <span>${r.name}</span>
        </div>
      `).join("");
    }

    function getActiveAgg(){
      const tipo = document.getElementById("tipoSel").value;
      return tipo==="__all__" ? yearCacheAll : yearCachePerType[tipo];
    }

    function updateDistrictVisibility(){
      const selected = document.getElementById("distritoSel").value;
      if (!selected || selected === "__all__"){
        for (const [key,group] of Object.entries(districtLayers)){
          if (!map.hasLayer(group)) group.addTo(map);
        }
        fitAll();
      } else {
        for (const [key,group] of Object.entries(districtLayers)){
          if (key === selected){ if (!map.hasLayer(group)) group.addTo(map); }
          else { if (map.hasLayer(group)) map.removeLayer(group); }
        }
        try { map.fitBounds(districtLayers[selected].getBounds(), {padding:[20,20]}); } catch(e){}
      }
    }

    async function applyFilters(){
      // currentYear já está atualizado pelo listener OU pela timeline
      const y = parseInt(document.getElementById("anoSel").value,10);
      currentYear = y;
      const data = getActiveAgg()[y] || { byDistrict:{}, min:0, max:0 };
      let totalAno = 0;
      for (const key of Object.keys(districtLayers)){
        if (!map.hasLayer(districtLayers[key])) continue;
        const total = data.byDistrict[key]?.total ?? 0;
        totalAno += total;
        setDistrictOpacity(key, total, data.min, data.max);
      }
      document.getElementById("sumTotal").textContent = totalAno.toLocaleString('pt-BR');
    }

    // ===== Timeline azul (drag) =====
    function buildTicks(){ ticks.innerHTML = YEARS.map(y=> `<div class="year">${y}</div>`).join(""); }
    function syncHandleToYear(){
      // Defensivo: lê direto do select
      const y = parseInt(document.getElementById("anoSel").value, 10);
      const idx = YEARS.indexOf(y);
      if (idx >= 0) {
        const pct = (idx / (YEARS.length - 1)) * 100;
        handle.style.left = pct + "%";
      }
    }
    function yearFromPosition(px){
      const rect = track.getBoundingClientRect();
      const clamped = Math.max(rect.left, Math.min(px, rect.right));
      const frac = (clamped - rect.left) / (rect.width);
      const idx = Math.round(frac * (YEARS.length - 1));
      return YEARS[idx];
    }
    function setYearFromPx(px){
      const y = yearFromPosition(px);
      if (y !== currentYear){
        currentYear = y;
        document.getElementById("anoSel").value = String(y);
        syncHandleToYear();
        applyFilters();
        refreshPopupsIfTimeline();
      } else {
        syncHandleToYear();
      }
    }
    function initDragTimeline(){
      let dragging = false;
      const onDown = (e)=>{ dragging=true; document.body.style.userSelect="none"; setYearFromPx(e.clientX ?? e.touches[0].clientX); };
      const onMove = (e)=>{ if (!dragging) return; setYearFromPx(e.clientX ?? (e.touches?e.touches[0].clientX:0)); };
      const onUp = ()=>{ dragging=false; document.body.style.userSelect=""; };
      handle.addEventListener("mousedown", onDown);
      handle.addEventListener("touchstart", onDown, {passive:true});
      window.addEventListener("mousemove", onMove);
      window.addEventListener("touchmove", onMove, {passive:true});
      window.addEventListener("mouseup", onUp);
      window.addEventListener("touchend", onUp);
      track.addEventListener("mousedown", (e)=> setYearFromPx(e.clientX));
      track.addEventListener("touchstart", (e)=> setYearFromPx(e.touches[0].clientX), {passive:true});
      syncHandleToYear();
    }

    function toggleTimelineAccordingToDistrict(){
      const selected = document.getElementById("distritoSel").value;
      const enable = (selected && selected !== "__all__");
      tl.style.display = enable ? "block" : "none";
      popupLayer.clearLayers();
      if (enable){ refreshPopupsIfTimeline(); }
    }

    function refreshPopupsIfTimeline(){
      popupLayer.clearLayers();
      const selected = document.getElementById("distritoSel").value;
      if (!selected || selected === "__all__") return;
      const group = districtLayers[selected];
      if (!group || !map.hasLayer(group)) return;
      const data = getActiveAgg()[currentYear] || { byDistrict:{} };
      const name = districtNameByKey[selected] || selected;
      const summary = data.byDistrict[selected];
      const center = (function(){try{return group.getBounds().getCenter();}catch(e){return map.getCenter();}})();
      const html = popupHtmlFor(name, summary);
      const p = L.popup({ autoClose:false, closeOnClick:false, closeButton:false, className:"auto-popup" })
        .setLatLng(center).setContent(html);
      popupLayer.addLayer(p);
    }

    // Reset
    document.getElementById("btnReset").addEventListener("click", ()=>{
      document.getElementById("tipoSel").value="__all__";
      document.getElementById("anoSel").value=String(YEARS[0]);
      currentYear = YEARS[0];
      document.getElementById("distritoSel").value="__all__";
      syncHandleToYear();
      popupLayer.clearLayers();
      updateDistrictVisibility();
      toggleTimelineAccordingToDistrict();
      applyFilters();
    });
  </script>
</body>
</html>
