<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa ‚Äì Ocorr√™ncias por Regi√£o</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --panel:#f5f7fb;
      --text:#0b1020;
      --muted:#5b6b82;
      --border:#e9eef7;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial;
      overflow-x:hidden;
    }

    .app {
      display:grid;
      grid-template-rows:auto 1fr auto;
      height:100%;
    }

    header {
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      align-items:center;
      padding:12px 16px;
      background:var(--panel);
      box-shadow:0 2px 12px rgba(0,0,0,.08);
      position:sticky;
      top:0;
      z-index:1000;
    }

    .title-block {
      display:flex;
      flex-direction:column;
      align-items:flex-start;
    }

    .title-block h1 {
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }

    .title-block .fonte {
      font-size:12px;
      margin-top:2px;
      color:#4b5563;
    }

    .controls {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      font-size:14px;
      color:var(--muted);
    }

    .badge {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background:#eef2f9;
    }

    .select {
      padding:6px 10px;
      border:1px solid #dbe3f0;
      border-radius:8px;
      background:#fff;
      color:#0b1020;
    }

    #map { height:100%; }

    .legend {
      position:absolute;
      background:rgba(255,255,255,0.98);
      color:#111827;
      padding:2px 12px;
      border-radius:10px;
      font:12px system-ui;
      z-index:500;
      border:1px solid var(--border);
      bottom:60px;
      right:10px;
    }

    .legend .row { display:flex; align-items:center; gap:8px; margin:4px 0; }
    .legend .dot { width:14px; height:14px; border-radius:4px; background:#1976d2; }

    /* LEGENDA RECOLH√çVEL */
    .color-legend {
      position:absolute;
      bottom:145px;
      right:10px;
      width:320px;
      max-height:350px;
      background:rgba(255,255,255,0.98);
      border:1px solid var(--border);
      border-radius:10px;
      padding:6px 12px 10px 12px;
      box-shadow:0 4px 14px rgba(0,0,0,0.15);
      overflow:hidden;
      transition:max-height 0.25s ease-in-out, padding 0.25s ease-in-out;
      z-index:600;
    }

    .color-legend.collapsed {
      max-height:32px;
      padding-top:4px;
      padding-bottom:4px;
    }

    .color-legend-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
      user-select:none;
    }

    .color-legend-header button {
      background:none;
      border:none;
      font-size:18px;
      cursor:pointer;
      padding:0;
      line-height:1;
    }

    .color-legend .items {
      margin-top:8px;
      max-height:280px;
      overflow-y:auto;
      display:flex;
      flex-wrap:wrap;
      gap:4px 12px;
      font-size: 11px;
    }

    .color-legend.collapsed .items {
      display:none;
    }

    .color-legend .item {
      display:flex;
      align-items:center;
      gap:8px;
      margin:2px 0;
    }

    .color-legend .box {
      width:14px;
      height:14px;
      border-radius:3px;
    }

    .color-legend.two-cols .item { width:48%; }

    .timeline {
      position:fixed;
      left:20px;
      right:20px;
      bottom:16px;
      z-index:1000;
      padding:10px 16px;
      background:transparent;
    }

    .timeline .label {
      margin:0 0 8px 2px;
      color:#1976d2;
      font:700 13px system-ui;
      text-shadow:0 1px 2px rgba(255,255,255,0.6);
    }

    .timeline .track {
      position:relative;
      height:8px;
      background:#fe6262;
      border-radius:999px;
      box-shadow:inset 0 0 0 2px rgba(255,255,255,0.8);
    }

    .timeline .handle {
      position:absolute;
      top:50%;
      transform:translate(-50%, -50%);
      width:20px;
      height:20px;
      border-radius:50%;
      background:#0d47a1;
      border:2px solid #bbdefb;
      box-shadow:0 2px 8px rgba(0,0,0,0.35);
      cursor:grab;
    }

    .timeline .ticks {
      display:flex;
      justify-content:space-between;
      margin-top:6px;
      color:#1976d2;
      font:700 12px/1 system-ui;
      text-shadow:0 1px 2px rgba(255,255,255,0.6);
    }

    .timeline .year { user-select:none; }

    .kml-busy {
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      background:rgba(0,0,0,0.75);
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      display:none;
      z-index:700;
    }

    .leaflet-popup-content-wrapper {
      border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.15);
    }

    .leaflet-popup-content {
      margin:12px 16px;
    }

    table.minimal {
      border-collapse:collapse;
      width:100%;
      font-size:12px;
    }

    table.minimal th,
    table.minimal td {
      border-bottom:1px solid #eee;
      padding:4px 6px;
      text-align:left;
    }

    .region-pill-wrapper { pointer-events:none; }

    .region-pill {
      background:#ffffff;
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      font-weight:600;
      color:#111827;
      border:1px solid rgba(15,23,42,0.08);
      box-shadow:0 1px 4px rgba(15,23,42,0.35);
      white-space:nowrap;
    }

    /* Tooltip flutuante de dica */
    .map-hint-wrapper{
      position:absolute;
      left:10px;
      bottom:110px;
      z-index:550;
    }

    .map-hint-trigger{
      background:rgba(255,255,255,0.96);
      border-radius:999px;
      padding:4px 10px;
      font-size:11px;
      color:#111827;
      border:1px solid var(--border);
      box-shadow:0 1px 4px rgba(15,23,42,0.18);
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:default;
    }

    .map-hint-tooltip{
      position:absolute;
      left:0;
      bottom:110%;
      background:rgba(255,255,255,0.98);
      border-radius:10px;
      padding:6px 10px;
      font-size:11px;
      color:#111827;
      border:1px solid var(--border);
      box-shadow:0 4px 12px rgba(0,0,0,0.18);
      max-width:260px;
      line-height:1.3;
      opacity:0;
      pointer-events:none;
      transform:translateY(4px);
      transition:opacity 0.15s ease, transform 0.15s ease;
      white-space:normal;
    }

    .map-hint-wrapper:hover .map-hint-tooltip{
      opacity:1;
      transform:translateY(0);
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="title-block">
        <h1>Ocorr√™ncias por Distrito/Bairro</h1>
        <span class="fonte">Fonte: SEGUP - Secretaria de Estado de Seguran√ßa P√∫blica e Defesa Social (2019 a jan/2026).</span>
      </div>
      <div class="controls">
        <label class="badge">Tipo:
          <select id="tipoSel" class="select">
            <option value="__all__">Todas</option>
            <option value="estupro_de_vulneravel_com_resultado_morte">Estupro de vulner√°vel com resultado morte</option>
            <option value="estupro_de_vulneravel">Estupro de vulner√°vel</option>
            <option value="estupro">Estupro</option>
            <option value="furto">Furto</option>
            <option value="homicidio">Homic√≠dio</option>
            <option value="latrocinio">Latroc√≠nio</option>
            <option value="lesao_corporal_seguida_de_morte">Les√£o corporal seguida de morte</option>
            <option value="lesao_corporal">Les√£o corporal</option>
            <option value="morte_no_transito">Morte no tr√¢nsito</option>
            <option value="roubo">Roubo</option>
            <option value="trafico_de_drogas">Tr√°fico de drogas</option>
          </select>
        </label>

        <label class="badge">Ano:
          <select id="anoSel" class="select"></select>
        </label>

        <label class="badge">Pesquisar por:
          <select id="modoSel" class="select">
            <option value="bairro" selected>Bairros</option>
            <option value="distrito">Distritos</option>
          </select>
        </label>

        <label class="badge" id="wrapDistrito">Distrito:
          <select id="distritoSel" class="select">
            <option value="__all__">Todos</option>
          </select>
        </label>

        <label class="badge" id="wrapBairro">Bairro:
          <select id="bairroSel" class="select">
            <option value="__all__">Todos</option>
          </select>
        </label>

        <span class="badge"><strong id="sumTotal">‚Äî</strong> registros*</span>

        <label class="badge">
          <input type="checkbox" id="pillToggle" checked style="margin:0;">
          Mostrar contagem na √°rea
        </label>

        <button id="btnReset" class="badge" style="cursor:pointer;">Limpar</button>
      </div>
    </header>

    <div id="map"></div>

    <div class="timeline" id="timeline">
      <div class="label">Linha do tempo (arraste o marcador)</div>
      <div class="track" id="track">
        <div class="handle" id="handle" style="left:0%;"></div>
      </div>
      <div class="ticks" id="ticks"></div>
    </div>
  </div>

  <div id="busy" class="kml-busy">Carregando dados...</div>

  <div class="legend">
    <h4 style="margin:0 0 6px;">Densidade de ocorr√™ncias</h4>
    <div class="row"><span class="dot" style="opacity:0.2"></span> Baixa</div>
    <div class="row"><span class="dot" style="opacity:0.55"></span> M√©dia</div>
    <div class="row"><span class="dot" style="opacity:0.9"></span> Alta</div>
  </div>

  <!-- LEGENDA DE CORES -->
  <div class="color-legend collapsed" id="colorLegend">
    <div class="color-legend-header" id="legendHeader">
      <span id="legendTitle">Bairros</span>
      <button id="legendBtn">‚ñº</button>
    </div>
    <div class="items" id="colorLegendItems"></div>
  </div>

  <!-- Tooltip de dica flutuante -->
  <div class="map-hint-wrapper">
    <div class="map-hint-trigger">
      üí° Dica
    </div>
    <div class="map-hint-tooltip">
      Clique nas regi√µes do mapa para ver mais detalhes. *Ocorr√™ncias com bairro "Outros‚Äù s√£o contabilizados, mas n√£o exibidos no mapa.
    </div>
  </div>

  <script>
    const CSV_DIR = "data/";
    const KML_DIR = "kml_poligonos/";
    const KML_DIST_DIR = "kml_poligonos/distritos/";

    /* LISTAS DE KMLs */

    const KML_BAIRROS = [
      { slug:"agua_verde",              label:"√Ågua Verde" },
      { slug:"arapari",                 label:"Arapari" },
      { slug:"aruan",                   label:"Aruan" },
      { slug:"bacabal",                 label:"Bacabal" },
      { slug:"barbolandia",             label:"Barbol√¢ndia" },
      { slug:"beira_rio",               label:"Beira Rio" },
      { slug:"betania",                 label:"Bet√¢nia" },
      { slug:"boa_vista",               label:"Boa Vista" },
      { slug:"bom_futuro",              label:"Bom Futuro" },
      { slug:"burajuba",                label:"Burajuba" },
      { slug:"cafezal",                 label:"Cafezal" },
      { slug:"caripi",                  label:"Caripi" },
      { slug:"centro_de_barcarena",     label:"Centro de Barcarena" },
      { slug:"comercial",               label:"Comercial" },
      { slug:"conjunto_habitacional_3", label:"Conjunto Habitacional 3" },
      { slug:"fazendinha",              label:"Fazendinha" },
      { slug:"itupanema",               label:"Itupanema" },
      { slug:"jardim_cabano_i_e_ii",    label:"Jardim Cabano I e II" },
      { slug:"jardim_cabano",           label:"Jardim Cabano" },
      { slug:"jardim_das_palmeiras",    label:"Jardim das Palmeiras" },
      { slug:"jardim_paraiso",          label:"Jardim Para√≠so" },
      { slug:"laranjal",                label:"Laranjal" },
      { slug:"nazare",                  label:"Nazar√©" },
      { slug:"novo_horizonte",          label:"Novo Horizonte" },
      { slug:"novo_paraiso",            label:"Novo Para√≠so" },
      { slug:"novo",                    label:"Novo" },
      { slug:"pedreira",                label:"Pedreira" },
      { slug:"pioneiro",                label:"Pioneiro" },
      { slug:"renascer_em_cristo",      label:"Renascer em Cristo" },
      { slug:"risco",                   label:"Risco" },
      { slug:"so_francisco",            label:"S√£o Francisco" },
      { slug:"vila_do_conde",           label:"Vila do Conde" },
      { slug:"vila_dos_cabanos",        label:"Vila dos Cabanos" },
      { slug:"zita_cunha",              label:"Zita Cunha" }
    ];

    const KML_DISTRITOS = [
      { slug:"barcarena",  label:"Barcarena (Sede)", key: normalizeDistrictName("Barcarena (Sede)") },
      { slug:"estradas",   label:"Estradas",         key: normalizeDistrictName("Estradas") },
      { slug:"ilhas",      label:"Ilhas",            key: normalizeDistrictName("Ilhas") },
      { slug:"murucupi",   label:"Murucupi",         key: normalizeDistrictName("Murucupi") },
      { slug:"viladoconde",label:"Vila do Conde",    key: normalizeDistrictName("Vila do Conde") }
    ];

    const CSV_SOURCES = [
      { key: "estupro_de_vulneravel_com_resultado_morte",   path: CSV_DIR + "estupro_de_vulneravel_com_resultado_morte.csv",   label: "Estupro de vulner√°vel com resultado morte" },
      { key: "estupro_de_vulneravel",                       path: CSV_DIR + "estupro_de_vulneravel.csv",                       label: "Estupro de vulner√°vel" },
      { key: "estupro",                                     path: CSV_DIR + "estupro.csv",                                     label: "Estupro" },
      { key: "furto",                                       path: CSV_DIR + "furto.csv",                                       label: "Furto" },
      { key: "homicidio",                                   path: CSV_DIR + "homicidio.csv",                                   label: "Homic√≠dio" },
      { key: "latrocinio",                                  path: CSV_DIR + "latrocinio.csv",                                  label: "Latroc√≠nio" },
      { key: "lesao_corporal_seguida_de_morte",             path: CSV_DIR + "lesao_corporal_seguida_de_morte.csv",             label: "Les√£o corporal seguida de morte" },
      { key: "lesao_corporal",                              path: CSV_DIR + "lesao_corporal.csv",                              label: "Les√£o corporal" },
      { key: "morte_no_transito",                           path: CSV_DIR + "morte_no_transito.csv",                           label: "Morte no tr√¢nsito" },
      { key: "roubo",                                       path: CSV_DIR + "roubo.csv",                                       label: "Roubo" },
      { key: "trafico_de_drogas",                           path: CSV_DIR + "trafico_de_drogas.csv",                           label: "Tr√°fico de drogas" }
    ];

    const COLOR_PALETTE = [
      "#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b",
      "#e377c2","#7f7f7f","#bcbd22","#17becf"
    ];
    const COLOR_MAP = {};
    function colorForRegion(key){
      if (!COLOR_MAP[key]) {
        const idx = Object.keys(COLOR_MAP).length % COLOR_PALETTE.length;
        COLOR_MAP[key] = COLOR_PALETTE[idx];
      }
      return COLOR_MAP[key];
    }

    /* HELPERS */

    function normalizeBasicName(s){
      if (!s) return "";
      return String(s)
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g,"")
        .replace(/[^A-Za-z0-9 ]+/g," ")
        .replace(/\s+/g," ")
        .trim()
        .toUpperCase();
    }

    // Para bairros, tipos, etc. (sem remapeamento especial)
    function normalizeName(s){
      return normalizeBasicName(s);
    }

    // Para distritos: aplica regras especiais (Ilhas, Murucupi, etc.)
    function normalizeDistrictName(s){
      let n = normalizeBasicName(s);

      // ILHAS: captura varia√ß√µes como "ILHA DAS ONCA", "ILHA DAS ON√áAS", "ILHA", etc.
      if (n.includes("ILHA") || n.includes("ONCA") || n.includes("ONCAS")) {
        return "ILHAS";
      }

      // VILA DOS CABANOS no campo distrito entra em Murucupi
      if (n === "VILA DOS CABANOS") {
        return "MURUCUPI";
      }

      // Barcarena (Sede)
      if (n.includes("BARCARENA") && n.includes("SEDE")) {
        return "BARCARENA (SEDE)";
      }
      if (n === "BARCARENA") {
        return "BARCARENA (SEDE)";
      }

      return n;
    }

    function parseNumber(val){
      if (val === null || val === undefined) return NaN;
      if (typeof val === "number") return val;
      let s = String(val).trim();
      if (!s) return NaN;
      if (s.indexOf(",") >= 0 && s.indexOf(".") === -1) {
        s = s.replace(",", ".");
      }
      s = s.replace(/\s+/g,"");
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : NaN;
    }

    function setBusy(on){
      document.getElementById("busy").style.display = on ? "block" : "none";
    }

    /* MAPA */

    const map = L.map('map').setView([-1.4558, -48.4902], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const bairroLayers   = {};
    const distritoLayers = {};

    const bairrosMeta   = {};
    const distritoMeta  = {};
    const bairroToDist  = {};
    const bairroSlugMap = {};
    const distritoSlugMap = {};
    const bairroPolygonCache = {};

    const popupLayer   = L.layerGroup().addTo(map);
    const markersLayer = L.layerGroup().addTo(map);
    const labelsLayer  = L.layerGroup().addTo(map);

    const yearCachePerTypeBairro   = {};
    const yearCacheAllBairro       = {};
    const yearCachePerTypeDistrito = {};
    const yearCacheAllDistrito     = {};
    const pointsPerType = {};
    const pointsAll     = {};

    let YEARS = [];
    let currentYear = null;

    let viewMode = 'bairro'; // 'bairro' ou 'distrito'

    function isDistrictMode(){
      return viewMode === 'distrito';
    }

    /* GEOMETRIA */

    function flattenLatLngs(latlngs){
      if (!Array.isArray(latlngs)) return [];
      if (latlngs.length === 0) return [];
      if (latlngs[0] instanceof L.LatLng){
        return [latlngs];
      }
      let result = [];
      latlngs.forEach(sub => {
        result = result.concat(flattenLatLngs(sub));
      });
      return result;
    }

    function pointInPolygon(lat, lng, poly){
      let inside = false;
      for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
        const xi = poly[i][0], yi = poly[i][1];
        const xj = poly[j][0], yj = poly[j][1];

        const intersect = ((yi > lng) !== (yj > lng)) &&
                          (lat < (xj - xi) * (lng - yi) / (yj - yi + 1e-12) + xi);
        if (intersect) inside = !inside;
      }
      return inside;
    }

    function pointInAnyPolygon(lat, lng, bairroKey){
      const polys = bairroPolygonCache[bairroKey];
      if (!polys || !polys.length) return true;
      for (const poly of polys){
        if (pointInPolygon(lat, lng, poly)) return true;
      }
      return false;
    }

    /* CSVs */

    async function loadCsv(path){
      return new Promise((resolve) => {
        Papa.parse(path, {
          header: true,
          download: true,
          dynamicTyping: true,
          complete: (res) => {
            const rows = (res.data || []).filter(r => r && r.ano && r.bairro);
            resolve(rows);
          },
          error: () => resolve([])
        });
      });
    }

    async function preloadCsvs(){
      const yearSet = new Set();

      for (const src of CSV_SOURCES){
        const rows = await loadCsv(src.path);

        const perTypeBairro   = {};
        const perTypeDistrito = {};
        yearCachePerTypeBairro[src.key]   = perTypeBairro;
        yearCachePerTypeDistrito[src.key] = perTypeDistrito;

        const pts = {};
        pointsPerType[src.key] = pts;

        for (const r of rows){
          const ano = parseInt(r.ano,10);
          if (!ano || isNaN(ano)) continue;

          const bairroRaw = r.bairro;
          if (!bairroRaw) continue;
          const bairroKey = normalizeName(bairroRaw);

          const distritoRaw = r.distrito || "";
          const distKey = distritoRaw ? normalizeDistrictName(distritoRaw) : null;

          yearSet.add(ano);

          if (!bairrosMeta[bairroKey]) {
            bairrosMeta[bairroKey] = {
              name: String(bairroRaw).trim(),
              distKey: distKey,
              distritoNome: distritoRaw ? String(distritoRaw).trim() : ""
            };
          }
          if (distKey){
            bairroToDist[bairroKey] = distKey;
            if (!distritoMeta[distKey]) {
              distritoMeta[distKey] = { name: distritoRaw.trim() };
            }
          }

          if (!perTypeBairro[ano]) perTypeBairro[ano] = { byRegion:{}, min:0, max:0 };
          const yearB = perTypeBairro[ano];
          if (!yearB.byRegion[bairroKey]) yearB.byRegion[bairroKey] = { total:0, byType:{} };
          const regB = yearB.byRegion[bairroKey];
          regB.total += 1;
          regB.byType[src.label] = (regB.byType[src.label] || 0) + 1;

          if (distKey){
            if (!perTypeDistrito[ano]) perTypeDistrito[ano] = { byRegion:{}, min:0, max:0 };
            const yearD = perTypeDistrito[ano];
            if (!yearD.byRegion[distKey]) yearD.byRegion[distKey] = { total:0, byType:{} };
            const regD = yearD.byRegion[distKey];
            regD.total += 1;
            regD.byType[src.label] = (regD.byType[src.label] || 0) + 1;
          }

          const latVal = r.latitude ?? r.Latitude ?? r.LATITUDE ?? r.lat ?? r.Lat ?? r.LAT;
          const lngVal = r.longitude ?? r.Longitude ?? r.LONGITUDE ?? r.lon ?? r.lng ?? r.LON;
          const lat = parseNumber(latVal);
          const lng = parseNumber(lngVal);

          if (Number.isFinite(lat) && Number.isFinite(lng)){
            if (!pts[ano]) pts[ano] = [];
            const p = {
              lat, lng,
              ano,
              bairroRaw,
              bairroKey,
              distrito: distritoRaw,
              mes: r.mes || "",
              local: r.local_ocorrencia || "",
              typeKey: src.key,
              typeLabel: src.label
            };
            pts[ano].push(p);

            if (!pointsAll[ano]) pointsAll[ano] = [];
            pointsAll[ano].push(p);
          }
        }

        Object.values(perTypeBairro).forEach(obj=>{
          const totals = Object.values(obj.byRegion).map(o=>o.total);
          obj.min = totals.length ? Math.min(...totals) : 0;
          obj.max = totals.length ? Math.max(...totals) : 0;
        });
        Object.values(perTypeDistrito).forEach(obj=>{
          const totals = Object.values(obj.byRegion).map(o=>o.total);
          obj.min = totals.length ? Math.min(...totals) : 0;
          obj.max = totals.length ? Math.max(...totals) : 0;
        });
      }

      for (const src of CSV_SOURCES){
        const perTypeB = yearCachePerTypeBairro[src.key];
        for (const [anoStr,obj] of Object.entries(perTypeB)){
          const ano = parseInt(anoStr,10);
          if (!yearCacheAllBairro[ano]) yearCacheAllBairro[ano] = { byRegion:{}, min:0, max:0 };
          const allYear = yearCacheAllBairro[ano];
          for (const [bairroKey,reg] of Object.entries(obj.byRegion)){
            if (!allYear.byRegion[bairroKey]) allYear.byRegion[bairroKey] = { total:0, byType:{} };
            const dest = allYear.byRegion[bairroKey];
            dest.total += reg.total;
            for (const [lbl,v] of Object.entries(reg.byType)){
              dest.byType[lbl] = (dest.byType[lbl] || 0) + v;
            }
          }
        }

        const perTypeD = yearCachePerTypeDistrito[src.key];
        for (const [anoStr,obj] of Object.entries(perTypeD)){
          const ano = parseInt(anoStr,10);
          if (!yearCacheAllDistrito[ano]) yearCacheAllDistrito[ano] = { byRegion:{}, min:0, max:0 };
          const allYearD = yearCacheAllDistrito[ano];
          for (const [distKey,reg] of Object.entries(obj.byRegion)){
            if (!allYearD.byRegion[distKey]) allYearD.byRegion[distKey] = { total:0, byType:{} };
            const dest = allYearD.byRegion[distKey];
            dest.total += reg.total;
            for (const [lbl,v] of Object.entries(reg.byType)){
              dest.byType[lbl] = (dest.byType[lbl] || 0) + v;
            }
          }
        }
      }

      Object.values(yearCacheAllBairro).forEach(obj=>{
        const totals = Object.values(obj.byRegion).map(o=>o.total);
        obj.min = totals.length ? Math.min(...totals) : 0;
        obj.max = totals.length ? Math.max(...totals) : 0;
      });
      Object.values(yearCacheAllDistrito).forEach(obj=>{
        const totals = Object.values(obj.byRegion).map(o=>o.total);
        obj.min = totals.length ? Math.min(...totals) : 0;
        obj.max = totals.length ? Math.max(...totals) : 0;
      });

      YEARS = Array.from(yearSet).sort((a,b)=>a-b);
      if (!YEARS.length) YEARS = [2024];
      currentYear = YEARS[YEARS.length - 1];
    }

    /* REGISTROS KML */

    function registerKmlBairros(){
      KML_BAIRROS.forEach(item => {
        const key = normalizeName(item.label);
        item.key = key;
        if (!bairrosMeta[key]) {
          bairrosMeta[key] = {
            name: item.label,
            distKey: null,
            distritoNome: ""
          };
        }
        bairroSlugMap[key] = item.slug;
      });
    }

    function registerKmlDistritos(){
      KML_DISTRITOS.forEach(item => {
        distritoSlugMap[item.key] = item.slug;
        // Aqui garantimos que o nome "bonito" venha dos KMLs,
        // sobrescrevendo nomes crus do CSV (como ILHA DAS ONCA / VILA DOS CABANOS).
        distritoMeta[item.key] = { name: item.label };
      });
    }

    function applyStyle(group, color, opacity){
      group.eachLayer(function(lyr){
        if (lyr.setStyle){
          lyr.setStyle({
            color: color,
            weight: 1.2,
            opacity: opacity,
            fillColor: color,
            fillOpacity: opacity
          });
        }
      });
    }

    async function loadBairroKmls(){
      for (const item of KML_BAIRROS){
        const bairroKey = item.key;
        const file = KML_DIR + item.slug + ".kml";

        await new Promise((resolve) => {
          const group = omnivore.kml(encodeURI(file));

          group.on("ready", function(){
            const color = colorForRegion(bairroKey);
            applyStyle(group, color, 0.25);
            bairroLayers[bairroKey] = group;

            const polygons = [];
            group.eachLayer(function(lyr){
              if (lyr.getLatLngs){
                const rings = flattenLatLngs(lyr.getLatLngs());
                rings.forEach(r => {
                  polygons.push(r.map(ll => [ll.lat, ll.lng]));
                });
              }
            });
            bairroPolygonCache[bairroKey] = polygons;

            group.eachLayer(function(lyr){
              lyr.on("click", (e) => {
                popupLayer.clearLayers();
                const html = buildBairroPopupHtml(bairroKey);
                const latlng = e.latlng || (lyr.getBounds ? lyr.getBounds().getCenter() : map.getCenter());
                L.popup()
                  .setLatLng(latlng)
                  .setContent(html)
                  .openOn(map);
              });
            });

            group.addTo(map);
            resolve();
          });

          group.on("error", function(){
            console.warn("Erro KML bairro:", file);
            resolve();
          });
        });
      }
    }

    async function loadDistritoKmls(){
      for (const item of KML_DISTRITOS){
        const distKey = item.key;
        const file = KML_DIST_DIR + item.slug + ".kml";

        await new Promise((resolve) => {
          const group = omnivore.kml(encodeURI(file));

          group.on("ready", function(){
            const color = colorForRegion(distKey);
            applyStyle(group, color, 0.25);
            distritoLayers[distKey] = group;

            group.eachLayer(function(lyr){
              lyr.on("click", (e) => {
                popupLayer.clearLayers();
                const html = buildDistritoPopupHtml(distKey);
                const latlng = e.latlng || (lyr.getBounds ? lyr.getBounds().getCenter() : map.getCenter());
                L.popup()
                  .setLatLng(latlng)
                  .setContent(html)
                  .openOn(map);
              });
            });

            resolve();
          });

          group.on("error", function(){
            console.warn("Erro KML distrito:", file);
            resolve();
          });
        });
      }
    }

    function fitAllVisible(){
      try{
        const visible = [];
        Object.values(bairroLayers).forEach(g=>{ if(map.hasLayer(g)) visible.push(g); });
        Object.values(distritoLayers).forEach(g=>{ if(map.hasLayer(g)) visible.push(g); });
        if (!visible.length) return;
        const fg = L.featureGroup(visible);
        map.fitBounds(fg.getBounds(), { padding:[20,20] });
      } catch(e){}
    }

    /* UI B√ÅSICA */

    const distritoSelEl = document.getElementById("distritoSel");
    const bairroSelEl   = document.getElementById("bairroSel");
    const pillToggle    = document.getElementById("pillToggle");
    const legendTitleEl = document.getElementById("legendTitle");
    const modoSelEl     = document.getElementById("modoSel");
    const wrapDistritoEl= document.getElementById("wrapDistrito");
    const wrapBairroEl  = document.getElementById("wrapBairro");

    function buildYearSelect(){
      const sel = document.getElementById("anoSel");
      sel.innerHTML = "";
      YEARS.forEach(y => {
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = String(y);
        sel.appendChild(opt);
      });
      sel.value = String(currentYear);
    }

    function buildDistritoSelect(){
      distritoSelEl.innerHTML = '<option value="__all__">Todos</option>';
      const list = Object.keys(distritoSlugMap).map(key => {
        const meta = distritoMeta[key];
        return { key, name: meta ? meta.name : key };
      }).sort((a,b)=>a.name.localeCompare(b.name,"pt-BR"));

      list.forEach(item=>{
        const o = document.createElement("option");
        o.value = item.key;
        o.textContent = item.name;
        distritoSelEl.appendChild(o);
      });
    }

    function buildBairroSelect(){
      bairroSelEl.innerHTML = '<option value="__all__">Todos</option>';
      const list = Object.entries(bairrosMeta)
        .filter(([key,meta]) => !!bairroSlugMap[key])
        .map(([key,val]) => ({ key, name: val.name }))
        .sort((a,b)=>a.name.localeCompare(b.name,"pt-BR"));

      list.forEach(item=>{
        const o = document.createElement("option");
        o.value = item.key;
        o.textContent = item.name;
        bairroSelEl.appendChild(o);
      });
      bairroSelEl.value = "__all__";
    }

    function getSelectedTypeKey(){
      return document.getElementById("tipoSel").value;
    }
    function getSelectedTypeLabel(){
      const k = getSelectedTypeKey();
      if (k === "__all__") return "Todas";
      const src = CSV_SOURCES.find(s=>s.key===k);
      return src ? src.label : k;
    }

    function getActiveAggBairro(){
      const tipo = getSelectedTypeKey();
      if (tipo === "__all__") return yearCacheAllBairro;
      return yearCachePerTypeBairro[tipo] || {};
    }

    function getActiveAggDistrito(){
      const tipo = getSelectedTypeKey();
      if (tipo === "__all__") return yearCacheAllDistrito;
      return yearCachePerTypeDistrito[tipo] || {};
    }

    /* VISIBILIDADE */

    function updatePolygonVisibility(){
      const districtMode = isDistrictMode();
      const bairroSel = bairroSelEl.value;
      const distSel   = distritoSelEl.value;

      if (districtMode){
        legendTitleEl.textContent = "Distritos";

        Object.values(bairroLayers).forEach(g=>{
          if (map.hasLayer(g)) map.removeLayer(g);
        });

        Object.entries(distritoLayers).forEach(([key,g])=>{
          const visible = (distSel === "__all__") || (distSel === key);
          if (visible) {
            if (!map.hasLayer(g)) map.addLayer(g);
          } else {
            if (map.hasLayer(g)) map.removeLayer(g);
          }
        });
      } else {
        legendTitleEl.textContent = "Bairros";

        Object.entries(bairroLayers).forEach(([key,g])=>{
          let visible = false;
          if (!bairroSel || bairroSel === "__all__") visible = true;
          else visible = (key === bairroSel);
          if (visible) {
            if (!map.hasLayer(g)) map.addLayer(g);
          } else {
            if (map.hasLayer(g)) map.removeLayer(g);
          }
        });

        Object.values(distritoLayers).forEach(g=>{
          if (map.hasLayer(g)) map.removeLayer(g);
        });
      }

      fitAllVisible();
    }

    /* POPUPS */

    function buildBairroPopupHtml(key){
      const meta = bairrosMeta[key];
      const name = meta ? meta.name : key;
      const aggYears = getActiveAggBairro();
      const yearObj = aggYears[currentYear] || { byRegion:{} };
      const info = yearObj.byRegion[key];

      const tipoLabel = getSelectedTypeLabel();

      if (!info || !info.total) {
        return [
          '<b>'+name+'</b>',
          '<div><b>Ano:</b> '+currentYear+'</div>',
          '<div><b>Tipo selecionado:</b> '+tipoLabel+'</div>',
          '<div style="margin-top:6px;">N√£o foram encontradas ocorr√™ncias com registros na regi√£o segundo a fonte.</div>'
        ].join("");
      }

      const total = info.total;
      const byType = info.byType || {};
      const rows = Object.entries(byType).sort((a,b)=>b[1]-a[1]);

      const table = rows.length
        ? '<table class="minimal"><thead><tr><th>Tipo</th><th>Ocorr√™ncias</th></tr></thead><tbody>'
          + rows.map(([label,val]) => '<tr><td>'+label+'</td><td>'+val+'</td></tr>').join("")
          + '</tbody></table>'
        : '<i>Sem detalhamento por tipo</i>';

      return [
        '<b>'+name+'</b>',
        '<div><b>Ano:</b> '+currentYear+'</div>',
        '<div><b>Tipo selecionado:</b> '+tipoLabel+'</div>',
        '<div><b>Total no ano:</b> '+total.toLocaleString("pt-BR")+'</div>',
        table+'<div style="font-size:10px;">*Registros cujas posi√ß√µes geogr√°ficas est√£o fora dos limites do bairro s√£o considerados mas n√£o s√£o exibidos.</div>'
      ].join("");
    }

    function buildDistritoPopupHtml(key){
      const meta = distritoMeta[key];
      const name = meta ? meta.name : key;
      const aggYears = getActiveAggDistrito();
      const yearObj = aggYears[currentYear] || { byRegion:{} };
      const info = yearObj.byRegion[key];

      const tipoLabel = getSelectedTypeLabel();

      if (!info || !info.total) {
        return [
          '<b>'+name+'</b>',
          '<div><b>Ano:</b> '+currentYear+'</div>',
          '<div><b>Tipo selecionado:</b> '+tipoLabel+'</div>',
          '<div style="margin-top:6px;">N√£o foram encontradas ocorr√™ncias com registros na regi√£o segundo a fonte.</div>'
        ].join("");
      }

      const total = info.total;
      const byType = info.byType || {};
      const rows = Object.entries(byType).sort((a,b)=>b[1]-a[1]);

      const table = rows.length
        ? '<table class="minimal"><thead><tr><th>Tipo</th><th>Ocorr√™ncias</th></tr></thead><tbody>'
          + rows.map(([label,val]) => '<tr><td>'+label+'</td><td>'+val+'</td></tr>').join("")
          + '</tbody></table>'
        : '<i>Sem detalhamento por tipo</i>';

      return [
        '<b>'+name+'</b>',
        '<div><b>Ano:</b> '+currentYear+'</div>',
        '<div><b>Tipo selecionado:</b> '+tipoLabel+'</div>',
        '<div><b>Total no ano:</b> '+total.toLocaleString("pt-BR")+'</div>',
        table
      ].join("");
    }

    function refreshFixedPopup(){
      popupLayer.clearLayers();
      const districtMode = isDistrictMode();

      if (districtMode){
        const distSel = distritoSelEl.value;
        if (!distSel || distSel === "__all__") return;
        const group = distritoLayers[distSel];
        if (!group || !map.hasLayer(group)) return;
        let center;
        try { center = group.getBounds().getCenter(); }
        catch(e){ center = map.getCenter(); }
        const html = buildDistritoPopupHtml(distSel);
        const p = L.popup({ autoClose:false, closeOnClick:false, closeButton:false })
                  .setLatLng(center)
                  .setContent(html);
        popupLayer.addLayer(p);
        return;
      }

      const bairroSel = bairroSelEl.value;
      if (!bairroSel || bairroSel === "__all__") return;
      const group = bairroLayers[bairroSel];
      if (!group || !map.hasLayer(group)) return;
      let center;
      try { center = group.getBounds().getCenter(); }
      catch(e){ center = map.getCenter(); }
      const html = buildBairroPopupHtml(bairroSel);
      const p = L.popup({ autoClose:false, closeOnClick:false, closeButton:false })
                .setLatLng(center)
                .setContent(html);
      popupLayer.addLayer(p);
    }

    function buildMarkerPopupHtml(p){
      const partes = [];
      partes.push('<b>'+p.typeLabel+'</b>');
      partes.push('<div><b>Ano:</b> '+p.ano+'</div>');
      if (p.mes) partes.push('<div><b>M√™s:</b> '+p.mes+'</div>');
      if (p.bairroRaw) partes.push('<div><b>Bairro:</b> '+p.bairroRaw+'</div>');

      // Aqui normalizamos o distrito para mostrar Ilhas / Murucupi, etc.
      if (p.distrito) {
        const dk = normalizeDistrictName(p.distrito);
        const dmeta = distritoMeta[dk];
        const nomeDistrito = dmeta ? dmeta.name : p.distrito;
        partes.push('<div><b>Distrito:</b> '+nomeDistrito+'</div>');
      }

      if (p.local) partes.push('<div><b>Local da ocorr√™ncia:</b> '+p.local+'</div>');
      return partes.join("");
    }

    /* MARCADORES (somente modo bairro) */

    function updateMarkers(){
      markersLayer.clearLayers();
      if (isDistrictMode()) return;

      const bairroSel = bairroSelEl.value;
      if (!bairroSel || bairroSel === "__all__") return;

      const tipo = getSelectedTypeKey();
      const ano  = currentYear;
      let pts = [];

      if (tipo === "__all__"){
        pts = pointsAll[ano] || [];
      } else {
        pts = (pointsPerType[tipo] && pointsPerType[tipo][ano]) || [];
      }

      pts.forEach(p => {
        if (p.bairroKey !== bairroSel) return;
        if (!Number.isFinite(p.lat) || !Number.isFinite(p.lng)) return;
        if (!pointInAnyPolygon(p.lat, p.lng, bairroSel)) return;

        const marker = L.circleMarker([p.lat, p.lng], {
          radius: 6,
          color: "#ff0000",
          fillColor: "#ff0000",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.9
        });

        marker.bindPopup(buildMarkerPopupHtml(p));
        markersLayer.addLayer(marker);
      });

      markersLayer.bringToFront();
    }

    /* PILLS (bairros e distritos) */

    function updateRegionLabels(){
      labelsLayer.clearLayers();
      if (!pillToggle.checked) return;

      const districtMode = isDistrictMode();

      if (districtMode){
        const distSel = distritoSelEl.value;
        const agg = getActiveAggDistrito()[currentYear] || { byRegion:{} };

        Object.entries(distritoLayers).forEach(([key,group])=>{
          if (!map.hasLayer(group)) return;
          if (distSel !== "__all__" && key !== distSel) return;

          const info = agg.byRegion[key];
          const total = info ? info.total : 0;
          if (!total || total <= 0) return;

          let center;
          try { center = group.getBounds().getCenter(); }
          catch(e){ return; }

          const html = '<div class="region-pill">'+total.toLocaleString("pt-BR")+'</div>';
          const marker = L.marker(center,{
            icon: L.divIcon({
              html,
              className:'region-pill-wrapper',
              iconSize:null
            })
          });
          labelsLayer.addLayer(marker);
        });

        return;
      }

      const bairroSel = bairroSelEl.value;
      const agg = getActiveAggBairro()[currentYear] || { byRegion:{} };

      if (bairroSel && bairroSel !== "__all__") return;

      Object.entries(bairroLayers).forEach(([key,group])=>{
        if (!map.hasLayer(group)) return;

        const info = agg.byRegion[key];
        const total = info ? info.total : 0;
        if (!total || total <= 0) return;

        let center;
        try { center = group.getBounds().getCenter(); }
        catch(e){ return; }

        const html = '<div class="region-pill">'+total.toLocaleString("pt-BR")+'</div>';
        const marker = L.marker(center,{
          icon: L.divIcon({
            html,
            className:'region-pill-wrapper',
            iconSize:null
          })
        });
        labelsLayer.addLayer(marker);
      });
    }

    function updatePillToggleState(){
      const modo   = modoSelEl.value;
      const bairro = bairroSelEl.value;

      // Se estiver pesquisando por Bairros E um bairro espec√≠fico foi escolhido,
      // desabilita o checkbox e desmarca para impedir intera√ß√£o.
      if (modo === 'bairro' && bairro && bairro !== "__all__") {
        pillToggle.disabled = true;
        pillToggle.checked  = false;
      } else {
        // Em qualquer outro caso, mant√©m o checkbox habilitado.
        pillToggle.disabled = false;
      }

      updateRegionLabels();
    }

    /* FILTROS / OPACIDADE */

    function applyFilters(){
      const districtMode = isDistrictMode();
      const aggAll = districtMode ? getActiveAggDistrito() : getActiveAggBairro();
      const yearObj = aggAll[currentYear] || { byRegion:{}, min:0, max:0 };
      const byRegion = yearObj.byRegion || {};
      const minVal = yearObj.min || 0;
      const maxVal = yearObj.max || 0;

      const totalAno = Object.values(byRegion).reduce((acc,reg)=>acc+(reg.total||0),0);
      document.getElementById("sumTotal").textContent = totalAno.toLocaleString("pt-BR");

      if (districtMode){
        Object.entries(distritoLayers).forEach(([key,g])=>{
          if (!map.hasLayer(g)) return;
          const info = byRegion[key];
          const value = info ? info.total : 0;
          let opacity = 0.2;

          if (value > 0 && maxVal > minVal && Number.isFinite(value)){
            const frac = (value - minVal) / (maxVal - minVal);
            opacity = 0.15 + frac * (0.9 - 0.15);
          } else if (value > 0 && maxVal === minVal && maxVal > 0){
            opacity = 0.9;
          }

          applyStyle(g, colorForRegion(key), opacity);
        });
      } else {
        Object.entries(bairroLayers).forEach(([key,g])=>{
          if (!map.hasLayer(g)) return;
          const info = byRegion[key];
          const value = info ? info.total : 0;
          let opacity = 0.2;

          if (value > 0 && maxVal > minVal && Number.isFinite(value)){
            const frac = (value - minVal) / (maxVal - minVal);
            opacity = 0.15 + frac * (0.9 - 0.15);
          } else if (value > 0 && maxVal === minVal && maxVal > 0){
            opacity = 0.9;
          }

          applyStyle(g, colorForRegion(key), opacity);
        });
      }

      refreshFixedPopup();
      updateMarkers();
      buildColorLegend();
      syncHandleToYear();
      updateRegionLabels();
    }

    /* LEGENDA DE CORES */

    function buildColorLegend(){
      const legend = document.getElementById("colorLegend");
      const itemsEl = document.getElementById("colorLegendItems");
      itemsEl.innerHTML = "";

      const bairroSel = bairroSelEl.value;
      const distSel   = distritoSelEl.value;
      const districtMode = isDistrictMode();

      if (districtMode){
        if (distSel === "__all__"){
          legend.classList.add("two-cols");
          Object.keys(distritoSlugMap)
            .map(key => ({ key, name:(distritoMeta[key] && distritoMeta[key].name) || key }))
            .sort((a,b)=>a.name.localeCompare(b.name,"pt-BR"))
            .forEach(item=>{
              const c = colorForRegion(item.key);
              const div = document.createElement("div");
              div.className = "item";
              div.innerHTML = '<span class="box" style="background:'+c+'"></span><span>'+item.name+'</span>';
              itemsEl.appendChild(div);
            });
        } else {
          legend.classList.remove("two-cols");
          const key = distSel;
          const meta = distritoMeta[key];
          const name = meta ? meta.name : key;
          const c = colorForRegion(key);
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = '<span class="box" style="background:'+c+'"></span><span>'+name+'</span>';
          itemsEl.appendChild(div);
        }
        return;
      }

      if (bairroSel && bairroSel !== "__all__" && bairrosMeta[bairroSel]) {
        legend.classList.remove("two-cols");
        const meta = bairrosMeta[bairroSel];
        const c = colorForRegion(bairroSel);
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = '<span class="box" style="background:'+c+'"></span><span>'+meta.name+'</span>';
        itemsEl.appendChild(div);
        return;
      }

      legend.classList.add("two-cols");
      Object.entries(bairrosMeta)
        .filter(([key,meta])=>!!bairroSlugMap[key])
        .map(([key,val])=>({ key, name:val.name }))
        .sort((a,b)=>a.name.localeCompare(b.name,"pt-BR"))
        .forEach(item=>{
          const c = colorForRegion(item.key);
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = '<span class="box" style="background:'+c+'"></span><span>'+item.name+'</span>';
          itemsEl.appendChild(div);
        });
    }

    /* TIMELINE */

    const track  = document.getElementById("track");
    const handle = document.getElementById("handle");
    const ticks  = document.getElementById("ticks");

    function buildTicks(){
      ticks.innerHTML = YEARS.map(y => '<div class="year">'+y+'</div>').join("");
    }

    function syncHandleToYear(){
      const idx = YEARS.indexOf(currentYear);
      if (idx < 0 || YEARS.length === 1){
        handle.style.left = "0%";
        return;
      }
      const pct = (idx / (YEARS.length - 1)) * 100;
      handle.style.left = pct + "%";
    }

    function yearFromPosition(px){
      const rect = track.getBoundingClientRect();
      const clamped = Math.max(rect.left, Math.min(px, rect.right));
      const frac = (clamped - rect.left) / rect.width;
      const idx = Math.round(frac * (YEARS.length - 1));
      return YEARS[idx];
    }

    function setYearFromPx(px){
      const y = yearFromPosition(px);
      currentYear = y;
      document.getElementById("anoSel").value = String(y);
      syncHandleToYear();
      applyFilters();
    }

    function initTimelineDrag(){
      let dragging = false;

      const onDown = (e) => {
        dragging = true;
        document.body.style.userSelect = "none";
        const clientX = e.clientX ?? (e.touches && e.touches[0].clientX);
        setYearFromPx(clientX);
      };

      const onMove = (e) => {
        if (!dragging) return;
        const clientX = e.clientX ?? (e.touches && e.touches[0].clientX);
        setYearFromPx(clientX);
      };

      const onUp = () => {
        dragging = false;
        document.body.style.userSelect = "";
      };

      handle.addEventListener("mousedown", onDown);
      handle.addEventListener("touchstart", onDown, { passive:true });
      window.addEventListener("mousemove", onMove);
      window.addEventListener("touchmove", onMove, { passive:true });
      window.addEventListener("mouseup", onUp);
      window.addEventListener("touchend", onUp);

      track.addEventListener("mousedown", (e) => setYearFromPx(e.clientX));
      track.addEventListener("touchstart", (e) => setYearFromPx(e.touches[0].clientX), { passive:true });
    }

    /* MODO (bairros/distritos) */

    function applyModeFromSelect(){
      viewMode = modoSelEl.value === 'distrito' ? 'distrito' : 'bairro';

      if (viewMode === 'bairro'){
        wrapBairroEl.style.display   = 'inline-flex';
        wrapDistritoEl.style.display = 'none';
        distritoSelEl.value = "__all__";
      } else {
        wrapBairroEl.style.display   = 'none';
        wrapDistritoEl.style.display = 'inline-flex';
        bairroSelEl.value = "__all__";
      }

      popupLayer.clearLayers();
      updatePolygonVisibility();
      applyFilters();
    }

    function refreshAll(){
      applyFilters();
    }

    /* LEGENDA RECOLH√çVEL */

    const legendEl   = document.getElementById("colorLegend");
    const legendBtn  = document.getElementById("legendBtn");
    const legendHead = document.getElementById("legendHeader");

    function toggleLegend() {
      const collapsed = legendEl.classList.toggle("collapsed");
      legendBtn.textContent = collapsed ? "‚ñ≤" : "‚ñº";
    }
    legendHead.addEventListener("click", toggleLegend);

    /* INIT */

    (async function init(){
      try{
        setBusy(true);
        await preloadCsvs();
        registerKmlBairros();
        registerKmlDistritos();
        await loadBairroKmls();
        await loadDistritoKmls();
        buildYearSelect();
        buildDistritoSelect();
        buildBairroSelect();
        buildTicks();
        syncHandleToYear();

        // modo inicial = bairros
        wrapDistritoEl.style.display = 'none';
        wrapBairroEl.style.display   = 'inline-flex';

        updatePolygonVisibility();
        refreshAll();
        fitAllVisible();
        initTimelineDrag();
        updatePillToggleState();
        legendEl.classList.add("collapsed");
        legendBtn.textContent = "‚ñ≤";


        document.getElementById("tipoSel").addEventListener("change", () => {
          applyFilters();
        });

        document.getElementById("anoSel").addEventListener("change", () => {
          const val = document.getElementById("anoSel").value;
          const y = parseInt(val,10);
          if (!isNaN(y)) currentYear = y;
          syncHandleToYear();
          applyFilters();
        });

        modoSelEl.addEventListener("change", () => {
          applyModeFromSelect();
          updatePillToggleState();
        });

        distritoSelEl.addEventListener("change", () => {
          if (!isDistrictMode()) return;
          updatePolygonVisibility();
          applyFilters();
        });

        bairroSelEl.addEventListener("change", () => {
          if (isDistrictMode()) return;
          updatePolygonVisibility();
          updatePillToggleState();
          applyFilters();
        });

        pillToggle.addEventListener("change", () => {
          updateRegionLabels();
        });

        document.getElementById("btnReset").addEventListener("click", () => {
          viewMode = 'bairro';
          modoSelEl.value = 'bairro';
          distritoSelEl.value = "__all__";
          bairroSelEl.value   = "__all__";
          wrapBairroEl.style.display   = 'inline-flex';
          wrapDistritoEl.style.display = 'none';
          document.getElementById("tipoSel").value = "__all__";
          currentYear = YEARS[YEARS.length - 1];
          document.getElementById("anoSel").value = String(currentYear);
          popupLayer.clearLayers();
          updatePolygonVisibility();
          updatePillToggleState();
          applyFilters();
        });

      } finally {
        setBusy(false);
      }
    })();
  </script>
</body>
</html>
